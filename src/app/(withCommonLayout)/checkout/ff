"use client";

import { useEffect, useState } from "react";
import axios from "axios";

const uploadToImgbb = async (file: File) => {
  const fd = new FormData();
  fd.append("image", file);

  const res = await axios.post(
    `https://api.imgbb.com/1/upload?key=ab454291ebee91b49b021ecac51be17c`,
    fd
  );

  return res.data.data.url;
};

type CartItem = {
  roomId: string;
  roomTitle: string;
  packageId: string;
  packageName: string;
  price: number;
  quantity: number;
  arrival: string;
  departure: string;
  guests: number; 
  
};

type CheckoutPageProps = {
  cart: CartItem[];
};

interface Facility {
  title: string;
  price: number;
}

export default function CheckoutPage() {
  const [cart, setCart] = useState<CartItem[]>([]);
  const [selectedFacilities, setSelectedFacilities] = useState<Facility[]>([]);

  const [nidFile, setNidFile] = useState<File | null>(null);
const [passportFile, setPassportFile] = useState<File | null>(null);
const [contact, setContact] = useState({ firstName: "", lastName: "", phone: "", email: "" });
const [address, setAddress] = useState("");
const [payment, setPayment] = useState({ cardNumber: "", expiry: "", securityCode: "" });
const [specialRequests, setSpecialRequests] = useState("");

const handleBookingSubmit = async () => {
  try {
    // Upload files to imageBB
    const nidUrl = nidFile ? await uploadToImgbb(nidFile) : undefined;
    const passportUrl = passportFile ? await uploadToImgbb(passportFile) : undefined;

    // Post all data to backend
    const res = await axios.post("https://nascent.virtualshopbd.com/api/booking/create", {
      cart,
      guests,
      facilities: selectedFacilities,
      contact,
      address,
      payment,
      specialRequests,
      nidUrl,
      passportUrl
    });

    if(res.data.success){
      alert("Booking successful!");
      localStorage.removeItem("hotel-cart"); // clear cart
    }
  } catch (err) {
    console.error(err);
    alert("Booking failed!");
  }
};

  useEffect(() => {
    const saved = localStorage.getItem("hotel-cart");
    if (saved) setCart(JSON.parse(saved));
  }, []);
  const serviceCharge = 500;
  const totalPrice = cart.reduce((sum, item) => sum + item.price * item.quantity + serviceCharge, 0) 
                   + selectedFacilities.reduce((sum, f) => sum + f.price, 0);

  const [guests, setGuests] = useState([{ firstName: "", lastName: "" }]);

  const addGuest = () => {
    setGuests([...guests, { firstName: "", lastName: "" }]);
  };

  const handleGuestChange = (index: number, field: string, value: string) => {
    const newGuests = [...guests];
    newGuests[index][field] = value;
    setGuests(newGuests);
  };

  const toggleFacility = (facility: Facility) => {
  if (selectedFacilities.find(f => f.title === facility.title)) {
    // remove facility if already selected
    setSelectedFacilities(selectedFacilities.filter(f => f.title !== facility.title));
  } else {
    // add facility
    setSelectedFacilities([...selectedFacilities, facility]);
  }
};


   const facilities: Facility[] = [
    { title: "Fan Facilities", price: 400 },
    { title: "Room Service", price: 500 },
    { title: "Breakfast", price: 300 },
    { title: "Extra Bed", price: 600 },
  ];

  const [selectedFacility, setSelectedFacility] = useState<Facility | null>(null);

  return (
    <div className="w-full bg-white flex justify-center px-5 md:px-0 py-10">
      <div className="w-full md:w-[1200px] grid grid-cols-1 md:grid-cols-12 gap-8 mt-10">
        
        {/* LEFT SECTION */}
        <div className="col-span-1 md:col-span-8 w-full">
          {/* CONTACT INFO */}
          <div className="mb-6 mt-10">
            <h2 className="text-[15px] text-black font-semibold mb-2">
              CONTACT INFO
            </h2>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
  {/* First Name */}
  <div className="flex flex-col">
    <label className="text-xs font-semibold text-black mb-1">First Name *</label>
    <input
  type="text"
  placeholder="Enter First Name"
  className="w-full border border-gray-300 text-black rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#b79a59] focus:border-[#b79a59] text-sm"
  value={contact.firstName}
  onChange={(e) => setContact({ ...contact, firstName: e.target.value })}
/>
  </div>

  {/* Last Name */}
  <div className="flex flex-col">
    <label className="text-xs font-semibold text-gray-700 mb-1">Last Name *</label>
   <input
  type="text"
  placeholder="Enter Last Name"
  className="w-full border border-gray-300 text-black rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#b79a59] focus:border-[#b79a59] text-sm"
  value={contact.lastName}
  onChange={(e) => setContact({ ...contact, lastName: e.target.value })}
/>
  </div>

  {/* Mobile Phone */}
  <div className="flex flex-col">
    <label className="text-xs font-semibold text-gray-700 mb-1">Mobile Phone *</label>
    <input
  type="tel"
  placeholder="Enter Mobile Number"
  className="w-full border border-gray-300 text-black rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#b79a59] focus:border-[#b79a59] text-sm"
  value={contact.phone}
  onChange={(e) => setContact({ ...contact, phone: e.target.value })}
/>
  </div>

  {/* Email */}
  <div className="flex flex-col">
    <label className="text-xs font-semibold text-black mb-1 ">Email *</label>
  <input
  type="email"
  placeholder="Enter Email Address"
  className="w-full border border-gray-300 text-black rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#b79a59] focus:border-[#b79a59] text-sm"
  value={contact.email}
  onChange={(e) => setContact({ ...contact, email: e.target.value })}
/>
  </div>

  {/* NID Card Upload */}
  <div className="flex flex-col">
    <label className="text-xs font-semibold text-gray-700 mb-1">NID Card Image</label>
    <label className="cursor-pointer border border-gray-300 text-black border-dashed rounded-md p-4 flex flex-col items-center justify-center hover:border-[#b79a59] hover:bg-gray-50 transition-all">
      <svg className="w-8 h-8 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v4h16v-4M12 12v8m0-8l-4 4m4-4l4 4m-8-8h16"/>
      </svg>
      <span className="text-xs text-gray-500">Click to upload NID card</span>
      <input
        type="file"
        accept="image/*"
        className="hidden"
      />
    </label>
  </div>

  {/* Passport Upload */}
  <div className="flex flex-col">
    <label className="text-xs font-semibold text-gray-700 mb-1">Passport Image</label>
    <label className="cursor-pointer border border-gray-300 border-dashed rounded-md p-4 flex flex-col items-center justify-center hover:border-[#b79a59] hover:bg-gray-50 transition-all">
      <svg className="w-8 h-8 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v4h16v-4M12 12v8m0-8l-4 4m4-4l4 4m-8-8h16"/>
      </svg>
      <span className="text-xs text-gray-500">Click to upload Passport</span>
      <input
        type="file"
        accept="image/*"
        className="hidden"
      />
    </label>
  </div>
</div>

          </div>

          {/* ADDRESS */}
      <div className="mb-6">
  <h2 className="text-[15px] font-semibold mb-2 text-black">ADDRESS</h2>
 <input
  type="text"
  placeholder="Enter your address"
  className="w-full border border-gray-300 text-black rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#b79a59] focus:border-[#b79a59]"
  value={address}
  onChange={(e) => setAddress(e.target.value)}
/>
</div>


          {/* BOOKING OPTIONS */}
          {/* <div className="border p-4 rounded-sm mb-6">
            <details>
              <summary className="cursor-pointer text-[14px] font-semibold text-black">
                BOOK STAY OPTIONS
              </summary>
              <p className="text-xs mt-2 text-black">
                Select additional options for your reservation.
              </p>
            </details>
          </div> */}

          {/* GUEST DETAILS */}
  <div className="border p-4 rounded-sm mb-6">
  <details open>
    <summary className="cursor-pointer text-[14px] font-semibold text-black">
      EXTRA FACILITIES
    </summary>

    <div className="mt-4 text-black">
      {facilities.map((facility, idx) => (
        <label
          key={idx}
          className="flex items-center gap-2 mb-2 cursor-pointer text-black"
        >
          <input
            type="checkbox"
            className="text-black"
            checked={selectedFacilities.some(f => f.title === facility.title)}
            onChange={() => toggleFacility(facility)}
          />
          <span className="text-sm">
            {facility.title} - ৳{facility.price}
          </span>
        </label>
      ))}

      {selectedFacilities.length > 0 && (
        <div className="mt-3 p-2 bg-gray-100 rounded-md text-sm text-black">
          <b>Selected Facilities:</b>
          <ul className="list-disc ml-5 mt-1">
            {selectedFacilities.map((f, idx) => (
              <li key={idx}>{f.title} - ৳{f.price}</li>
            ))}
          </ul>
        </div>
      )}
    </div>
  </details>
</div>






          {/* SPECIAL REQUESTS */}
          <div className="border p-4 rounded-sm mb-6">
            <details open>
              <summary className="cursor-pointer text-[14px] font-semibold text-black">
                SPECIAL REQUESTS
              </summary>
              <textarea
                className="w-full border text-black rounded-sm px-3 py-2 text-sm mt-3"
                placeholder="Please enter your requests..."
              ></textarea>
            </details>
          </div>

          {/* PERSONALIZE YOUR STAY */}
        

          {/* PAYMENT METHODS */}
          <div className="mb-6 text-black">
            <h2 className="text-[15px] font-semibold mb-2">PAYMENT</h2>
            <p className="text-xs text-gray-600 mb-2">
              We accept the following credit cards:
            </p>
            <div className="flex gap-2 mb-4">
              <div className="w-10 h-6 bg-gray-300"></div>
              <div className="w-10 h-6 bg-gray-300"></div>
              <div className="w-10 h-6 bg-gray-300"></div>
            </div>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label className="text-xs text-gray-600">Card Number *</label>
                <input className="w-full border rounded-sm px-3 py-2 mt-1 text-sm" />
              </div>
              <div>
                <label className="text-xs text-gray-600">Expiry *</label>
                <input className="w-full border rounded-sm px-3 py-2 mt-1 text-sm" />
              </div>
              <div>
                <label className="text-xs text-gray-600">Security Code *</label>
                <input className="w-full border rounded-sm px-3 py-2 mt-1 text-sm" />
              </div>
            </div>
          </div>

          {/* POLICIES */}
          <div className="border p-4 rounded-sm mb-6 bg-[#fafafa] text-[13px] leading-[18px]">
            <h3 className="font-semibold text-black mb-2 text-[14px]">POLICIES</h3>
            <p className="text-black">
              <b>Check-in:</b> 3:00 PM
            </p>
            <p className="text-black">
              <b>Check-out:</b> 12:00 PM
            </p>
            <p className="mt-2 text-black">
              Guests must provide valid ID at check-in. Late cancellations may
              incur additional fees.
            </p>
          </div>

          {/* AGREEMENTS */}
          <div className="border p-4 rounded-sm mb-6 text-[13px] leading-[18px] text-black">
            <h3 className="font-semibold mb-2 text-[14px]">AGREEMENTS</h3>
            <div className="space-y-2">
              <label className="flex items-start gap-2">
                <input type="checkbox" className="mt-1" />
                <span>I agree to the Terms & Conditions.</span>
              </label>
              <label className="flex items-start gap-2">
                <input type="checkbox" className="mt-1" />
                <span>I agree to the cancellation policy.</span>
              </label>
              <label className="flex items-start gap-2">
                <input type="checkbox" className="mt-1" />
                <span>I authorize payment for this reservation.</span>
              </label>
            </div>
          </div>

          <button className="w-full bg-[#b79a59] text-white py-3 font-semibold rounded-sm hover:bg-[#a5894e]">
            CONFIRM BOOKING
          </button>
        </div>

        {/* RIGHT SIDE SUMMARY */}
      <div className="col-span-1 md:col-span-4 w-full">
          <div className="w-full md:min-h-screen bg-[#f5f5f5] text-black flex flex-col items-center py-10 gap-10">

            {/* CART SUMMARY */}
            <div className="w-full md:w-[360px] bg-white shadow-md p-5 rounded-md">
              <h3 className="text-[16px] mb-2 font-semibold">
                Your Cart: {cart.length} {cart.length === 1 ? "Item" : "Items"}
              </h3>

              {/* TOTAL */}
              <div className="flex justify-between text-[14px]">
                <span>Total</span>
                <span className="font-bold">৳ {totalPrice}</span>
              </div>

              <p className="text-[12px] text-gray-500 mt-1">Including taxes and fees</p>

              {cart.length === 0 && (
                <div className="border p-4 mt-3 rounded-md text-gray-500">
                  <div className="font-bold">No items in your cart</div>
                  <div className="flex justify-between text-[14px] mt-2">
                    <span>Room Charges</span>
                    <span>৳ 0</span>
                  </div>
                  <div className="flex justify-between text-[14px] mt-1">
                    <span>Service Charge</span>
                    <span>৳ 0</span>
                  </div>
                  <div className="flex justify-between text-[14px] mt-1">
                    <span>Stay</span>
                    <span>—</span>
                  </div>
                </div>
              )}

              {cart.length === 0 ? (
        <p>Your cart is empty.</p>
      ) : (
        <div className="space-y-4">
          {cart.map((item) => (
            <div key={item.packageId} className="p-4 bg-white rounded-md shadow">
              <div className="font-semibold">{item.roomTitle}</div>
              <div className="text-gray-600">{item.packageName}</div>
              <div className="flex justify-between text-[14px] mt-1">
  <span>Guests</span>
  <span>{item.guests}</span>
</div>

              <div>
                {item.arrival} → {item.departure}
              </div>
              <div>Quantity: {item.quantity}</div>
              <div>Price: ৳ {item.price * item.quantity}</div>
               <div className="flex justify-between text-[14px] mt-1">
          <span>Service Charge</span>
          <span>৳ {serviceCharge}</span>
        </div>
            </div>
          ))}
          <div className="font-bold text-lg">Total: ৳ {totalPrice}</div>

           
        </div>
      )}

              <div className="flex justify-between font-bold text-[16px] mt-4">
                <span>Total</span>
                <span>৳ {totalPrice}</span>
              </div>

              <button className="w-full bg-[#b89c5a] text-white py-3 rounded-md mt-4 hover:bg-[#a88a4f] text-sm">
                CHECKOUT
              </button>
            </div>

          </div>
        </div>

      </div>
    </div>
  );
}
