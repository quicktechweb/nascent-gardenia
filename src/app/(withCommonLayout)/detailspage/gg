"use client";

import Image from "next/image";
import { useEffect, useRef, useState } from "react";
import { motion, AnimatePresence, Variants } from "framer-motion";
import { HiChevronLeft, HiChevronRight } from "react-icons/hi";
import axios from "axios";
import { useViewportScroll, useTransform,useSpring  } from "framer-motion";

interface BasicInfo {
  bedType: string;
  size: string;
  capacity: number;
  numberOfRooms: number;
  bedSize: string;
  floorInformation: string;
  view: string;
  checkinOut: string;
  extraBed: string;
  connectingRoom: string;
}

interface Room {
  id: string;
  title: string;
  bgColor: string;
  description: string;
  carouselImages: string[];
  facilities: string[];
  floorPlanImage: string;
  basicInfo: BasicInfo;
}

interface ApiRoomData {
  _id: string;
  heroImage: string;
  roomsdata: Room[];
  __v: number;
}

interface ApiResponse {
  success: boolean;
  data: ApiRoomData[];
}

export default function RoomLayout() {
  const [roomsdata, setRoomsdata] = useState<Room[]>([]);
  const [heroImage, setHeroImage] = useState<string>("");
  const [isOpen, setIsOpen] = useState<number | null>(null);
  const [currentRoomIndex, setCurrentRoomIndex] = useState(0);
  const [currentSection, setCurrentSection] = useState<"initial" | "roomType" | "services">("initial");

  const roomRefs = useRef<HTMLDivElement[]>([]);
  const carouselRefs = useRef<HTMLDivElement[]>([]);

  const [windowWidth, setWindowWidth] = useState(0);

useEffect(() => {
  setWindowWidth(window.innerWidth); // only runs on client
}, []);
  // Fetch rooms from API
  useEffect(() => {
  const fetchRooms = async () => {
    try {
      const res = await axios.get<ApiResponse>("https://nascent.virtualshopbd.com/api/rooms");

      // Flatten all rooms from all data objects
      const allRooms: Room[] = res.data.data.flatMap(item => item.roomsdata);

      setRoomsdata(allRooms);

      // Optional: Set heroImage to first item’s hero
      if (res.data.data.length > 0) {
        setHeroImage(res.data.data[0].heroImage);
      }
    } catch (err) {
      console.error("Failed to fetch rooms:", err);
    }
  };
  fetchRooms();
}, []);


  const halfReveal: Variants = {
    hidden: { opacity: 0, y: 80, scale: 0.95, clipPath: "inset(40% 0% 0% 0%)", filter: "blur(6px)" },
    show: { opacity: 1, y: 0, scale: 1, clipPath: "inset(0% 0% 0% 0%)", filter: "blur(0px)", transition: { duration: 1.3, ease: [0.16, 1, 0.3, 1] } }
  };

  // Scroll marker effect
  useEffect(() => {
    const handleScroll = () => {
      let found = false;
      roomRefs.current.forEach((ref, index) => {
        if (!ref) return;
        const rect = ref.getBoundingClientRect();
        if (rect.top < window.innerHeight / 2 && rect.bottom > window.innerHeight / 2) {
          setCurrentRoomIndex(index);
          setCurrentSection("roomType");
          found = true;
        }
      });

      const services = document.getElementById("services");
      if (services) {
        const rect = services.getBoundingClientRect();
        if (rect.top < window.innerHeight / 2 && rect.bottom > 0) {
          setCurrentSection("services");
          found = true;
        }
      }

      if (!found) setCurrentSection("initial");
    };

    window.addEventListener("scroll", handleScroll);
    return () => window.removeEventListener("scroll", handleScroll);
  }, []);

  const getRightBg = () => {
    switch (currentSection) {
      case "roomType":
        return "bg-[#e9e0d9] text-black";
      case "services":
        return " text-black";
      default:
        return "bg-[#e9e0d9] text-black";
    }
  };

  const scrollCarousel = (index: number, direction: "prev" | "next") => {
    const el = carouselRefs.current[index];
    if (!el) return;
    const scrollAmount = el.offsetWidth;
    el.scrollBy({ left: direction === "next" ? scrollAmount : -scrollAmount, behavior: "smooth" });
  };

  const { scrollY } = useViewportScroll();

  // Transformations for scroll animation
  const scale = useTransform(scrollY, [0, 400], [1, 1.2]); // zoom in
  const translateX = useTransform(scrollY, [0, 400], [0, -50]); // move left
  const translateY = useTransform(scrollY, [0, 400], [0, -50]); 

  return (
    <div className={`w-full min-h-screen transition-colors duration-700 ${getRightBg()}`}>
      <div className="flex">
        {/* Sidebar */}
      <div className="hidden md:flex w-1/5 max-w-3xl sticky top-72 self-start ">
  <div className="p-12 space-y-6 text-sm">
    <h3 className="text-lg font-bold mb-6">Index</h3>
    <p className="font-semibold">Room Type</p>

    <div className="space-y-4">
      {roomsdata.map((room, i) => (
        <div
          key={room.id}
          className="flex cursor-pointer items-center"
          onClick={() => {
            roomRefs.current[i]?.scrollIntoView({
              behavior: "smooth",
              block: "start",
            });
            setCurrentRoomIndex(i);
            setCurrentSection("roomType");
          }}
        >
          <p
            className={`px-2 py-1 rounded transition-colors duration-300 ${
              currentRoomIndex === i ? "bg-gray-800/20" : "hover:bg-gray-800/10"
            } text-lg opacity-60`}
          >
            - {room.title}
          </p>
        </div>
      ))}
    </div>
  </div>
</div>


        {/* Main Content */}
        <div className="w-full md:w-4/5 md:-ml-[5%] px-2 transition-colors duration-700 mt-24">
          {/* Hero Image */}
       <div className="w-full relative h-screen overflow-hidden">
  {/* Hero Image */}
 <motion.div
  style={{
    scale: useSpring(useTransform(scrollY, [0, 500], [1, 1.35]), { stiffness: 50, damping: 20 }),
    x: useSpring(
      useTransform(scrollY, [0, 500], [0, windowWidth ? -windowWidth * 0.2 : 0]), // use windowWidth state
      { stiffness: 50, damping: 20 }
    ),
    y: useSpring(useTransform(scrollY, [0, 500], [0, -50]), { stiffness: 50, damping: 20 }),
    rotate: useSpring(useTransform(scrollY, [0, 500], [0, 1]), { stiffness: 30, damping: 20 }),
  }}
  className="absolute top-0 left-0 w-full h-full z-0"
>

    <Image
      src={heroImage || "https://via.placeholder.com/1500"}
      alt="Hero"
      fill
      className="object-cover"
    />
  </motion.div>

  {/* Hero Text Overlay */}
  <motion.div
    style={{
      y: useSpring(useTransform(scrollY, [0, 500], [0, -30]), { stiffness: 50, damping: 20 }),
      opacity: useSpring(useTransform(scrollY, [0, 300], [1, 0.8]), { stiffness: 50, damping: 20 }),
    }}
    className="absolute inset-0 flex flex-col justify-center items-center text-white px-4 z-10 pointer-events-none"
  >
    <h1 className="text-5xl md:text-6xl font-bold drop-shadow-lg text-center">
      Luxury Rooms
    </h1>
    <p className="text-lg md:text-2xl drop-shadow-md max-w-2xl text-center mt-4">
      Discover our premium rooms and services
    </p>
  </motion.div>
</div>


          {/* Rooms Section */}
        <div className="w-full px-4 transition-colors duration-700">
  {roomsdata.map((room, roomIndex) => (
    <div
      key={room.id}
      className="my-8"
      ref={(el: HTMLDivElement | null) => {
        if (el) roomRefs.current[roomIndex] = el;
      }}
    >
      <h1 className="text-3xl md:text-4xl font-serif mb-4">{room.title}</h1>
      <p className="max-w-2xl mb-4">{room.description}</p>

      {/* Carousel */}
      <div className="relative overflow-hidden w-full mb-6">
        <button
          onClick={() => scrollCarousel(roomIndex, "prev")}
          className="absolute left-2 top-1/2 -translate-y-1/2 z-10 bg-white/80 hover:bg-white rounded-full p-3"
        >
          <HiChevronLeft className="text-2xl" />
        </button>
        <button
          onClick={() => scrollCarousel(roomIndex, "next")}
          className="absolute right-2 top-1/2 -translate-y-1/2 z-10 bg-white/80 hover:bg-white rounded-full p-3"
        >
          <HiChevronRight className="text-2xl" />
        </button>

        <motion.div
          className="flex gap-4 overflow-x-auto scrollbar-hide"
          ref={(el: HTMLDivElement | null) => {
            if (el) carouselRefs.current[roomIndex] = el;
          }}
          initial="hidden"
          whileInView="show"
          viewport={{ once: true, amount: 0.3 }}
          variants={{ hidden: {}, show: { transition: { staggerChildren: 0.2 } } }}
        >
          {room.carouselImages.map((src, i) => (
            <motion.div
              key={i}
              className="relative min-w-[300px] md:min-w-[670px] h-72 md:h-[600px] flex-shrink-0 overflow-hidden rounded-xl"
              variants={halfReveal} // your animation variant
            >
              <Image src={src} alt={`${room.title} image ${i + 1}`} fill className="object-cover" />
            </motion.div>
          ))}
        </motion.div>
      </div>

      {/* Accordion */}
      <div className="w-full border border-gray-200 rounded-lg overflow-hidden">
        <button
          onClick={() => setIsOpen(isOpen === roomIndex ? null : roomIndex)}
          className="w-full flex justify-between items-center bg-gray-100 px-4 py-3 text-left"
        >
          <span className="font-medium text-gray-700">Basic Information</span>
          <span className="text-2xl font-bold text-gray-700">{isOpen === roomIndex ? "−" : "+"}</span>
        </button>
        <AnimatePresence initial={false}>
          {isOpen === roomIndex && (
            <motion.div
              key="content"
              initial={{ height: 0, opacity: 0 }}
              animate={{ height: "auto", opacity: 1 }}
              exit={{ height: 0, opacity: 0 }}
              transition={{ duration: 0.3 }}
              className="bg-white text-gray-600"
            >
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 px-4 py-3">
                <div className="space-y-1">
                  {Object.entries(room.basicInfo).map(([key, value]) => (
                    <p key={key}>
                      <strong>{key}:</strong> {value}
                    </p>
                  ))}
                </div>
                <div className="space-y-1">
                  <p>
                    <strong>Room facilities & Amenities:</strong>
                  </p>
                  {room.facilities.map((f, i) => (
                    <p key={i}>{f}</p>
                  ))}
                </div>
              </div>

              {/* <div className="w-full h-64 flex justify-center py-4 border-t">
                <Image
                  src={room.floorPlanImage}
                  alt={`${room.title} Floor Plan`}
                  width={800}
                  height={600}
                  className="object-contain"
                />
              </div> */}
            </motion.div>
          )}
        </AnimatePresence>
      </div>
    </div>
  ))}
</div>


        </div>
      </div>
    </div>
  );
}
